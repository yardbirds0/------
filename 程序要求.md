### **项目需求规格说明书：AI辅助的财务报表数据映射与填充工具 (最终版)**

#### **1. 项目概述**

**1.1. 项目目标**
开发一个基于 **`PySide6`** 的专业桌面应用程序，旨在自动化处理Excel财务报表。该工具能智能地将多个“数据来源表”中的数据，经过指定的计算（加、减、乘、除等），精确填充到“快报表”的对应项目中，并提供一个专业、美观、高效的用户交互界面。

**1.2. 核心挑战**
“快报表”中的项目与“数据来源表”中的数据并非简单的一一对应关系，而是需要基于会计准则进行多项数据的组合运算。这种映射关系是未知的，需要被动态发现。

**1.3. 解决方案**
本工具采用“AI预处理 + 用户精修”的混合智能模式。首先，利用大型语言模型（LLM）根据报表项目名称和层级关系，生成一个初始的、推测性的计算公式（映射关系）。然后，提供一个强大、直观的用户界面，让用户可以审核、修改、完善这些公式，最终执行计算并导出结果。

---

#### **2. 核心概念与术语定义**

*   **工作簿 (Workbook):** 用户加载的单个Excel文件，包含多个工作表。
*   **快报表 (Flash Report Sheet):** 需要被填充数据的工作表。其特点是包含特定的关键词（如“快报”），且部分单元格为空，等待计算结果。
*   **数据来源表 (Data Source Sheet):** 提供原始数据的工作表，用于计算“快报表”中的项目值。
*   **目标项 (Target Item):** “快报表”中需要被计算和填充的项目（例如，“19. 流动资产”）。
*   **来源项 (Source Item):** “数据来源表”中可以被引用的原子数据项（例如，“利润表”中的“营业成本”）。
*   **映射公式 (Mapping Formula):** 定义一个“目标项”如何由一个或多个“来源项”通过数学运算（`+`, `-`, `*`, `/`）得到的表达式。

---

#### **3. 功能需求 (Functional Requirements)**

**模块一：项目初始化与数据加载**

*   **3.1. 文件加载:**
    *   支持用户选择并加载一个或多个Excel工作簿（`.xlsx`, `.xls`）。
    *   程序读取所有工作簿中的所有工作表（Sheet）名称。

*   **3.2. 工作表分类:**
    *   **3.2.1. 自动分类:** 程序根据工作表名称自动分类。默认规则：名称包含“快报”的，归类为“快报表”；其余所有表归类为“数据来源表”。
    *   **3.2.2. 用户审核与调整:** 提供一个双栏界面，左侧为“快报表”列表，右侧为“数据来源表”列表。用户可以通过拖拽或按钮，手动调整工作表的归属，确保分类的100%准确性。

**模块二：数据结构化提取 (Data Extraction & Structuring)**

* **3.3. 目标表项目提取:**
    * 程序遍历所有已确认为“目标表”的工作表。
    * 针对每一个目标表，程序需要解析出所有待填写的项目。假设标准格式为：A列为序号，B列为项目名称，D列为待填写数值的单元格。
    * **层级关系识别:** 程序需要识别项目之间的层级关系（父子关系）。识别逻辑建议为：通过B列内容的 **前置缩进**（空格数）来判断。例如，“其中：主营业务收入”的缩进比“一、营业总收入”多，则前者为后者的子项。
    * **结构化存储:** 提取出的每个项目应存储为包含以下信息的对象（Object）：
        ```json
        {
          "id": "Target_Sheet1_Item_001", // 唯一标识符
          "sheet_name": "快报表1",
          "item_name": "一、营业总收入",
          "item_index": "1", // 原始序号
          "level": 0, // 层级，0为顶级
          "target_cell": "D5", // 待填入数据的单元格地址
          "formula": null, // 初始公式为空
          "calculated_value": null // 初始计算值为空
        }
        ```

* **3.4. 数据源表项目提取:**
    * 程序遍历所有已确认为“数据源表”的工作表。
    * 提取所有可能作为数据来源的条目。提取逻辑为：扫描每一行，如果某单元格包含文本（作为项目名），且其右侧相邻或指定列（如D列）的单元格包含数值，则视为一个有效的数据源项。
    * **结构化存储:** 提取出的每个数据源项应存储为包含以下信息的对象：
        ```json
        {
          "id": "Source_Sheet1_Item_123", // 唯一标识符
          "sheet_name": "利润表",
          "item_name": "其中：营业成本",
          "source_cell": "D12", // 数据所在的单元格地址
          "value": 150000.00 // 该单元格的实际数值
        }
        ```

**模块三：AI 智能映射 (AI-Powered Mapping)**

* **3.5. AI 配置界面:**
    * 在窗口中提供一个设置区域，用于设置调用大语言模型（LLM）的参数。
    * 必须包含以下输入字段，并遵循 OpenAI 通用接口标准：
        * API URL (Endpoint)
        * API Key (密钥)
        * Model Name (模型名称，如 `gpt-4-turbo`, `claude-3-opus-20240229` 等)
        * System Prompt (系统提示词)：一个大的文本框，允许用户自定义对 AI 的指令。
* **3.6. 构建并发送请求:**
    * 当用户点击“请求AI分析”按钮时，程序将已提取的“目标表项目”和“数据源表项目”整合成一个结构化的 JSON 发送给 AI。
    * **请求JSON格式定义:**
        ```json
        {
          "task_description": "Analyze financial items and create calculation formulas.",
          "target_items": [
            { "id": "T001", "name": "一、营业总收入", "level": 0 },
            { "id": "T002", "name": "其中：营业收入", "level": 1 },
            { "id": "T003", "name": "减：营业成本", "level": 0 }
          ],
          "source_items": [
            { "id": "S001", "sheet": "利润表", "name": "营业收入", "cell": "D10" },
            { "id": "S002", "sheet": "利润表", "name": "营业成本", "cell": "D12" },
            { "id": "S003", "sheet": "利润表", "name": "税金及附加", "cell": "D15" }
          ]
        }
        ```
* **2.3.3. 解析AI响应:**
    * 程序需要能解析AI返回的JSON数据。AI的响应必须遵循预定义的格式。
    * **响应JSON格式定义:**
        ```json
        {
          "mappings": [
            {
              "target_id": "T001",
              "formula": "[利润表:\"营业收入\"](D10)"
            },
            {
              "target_id": "T002",
              "formula": "[利润表:\"营业收入\"](D10)"
            },
            {
              "target_id": "T003",
              "formula": "[利润表:\"营业成本\"](D12) + [利润表:\"税金及附加\"](D15)"
            }
          ]
        }
        ```
* **2.3.4. 初步填充映射关系:** 程序根据解析后的AI响应，将 `formula` 字符串自动填充到主界面中对应 `target_id` 项目的“映射公式”栏中。

**模块四：用户交互与公式编辑 (功能)**

*   **3.8. 映射公式表示法:**
    *   我们采用一种更清晰、更易于解析的公式表示法：`[工作表名]![项目名]`。
    *   例如：`[利润表]![营业成本] + [利润表]![税金及附加]`。
    *   此格式在显示时对用户友好，在计算时也易于程序解析。

*   **3.9. 交互式公式编辑:**
    *   **显示:** AI生成的公式会初步填入编辑区。
    *   **修改:** 用户可以直接在编辑框中手动输入或修改公式，支持 `+`, `-`, `*`, `/`, `(`, `)`。
    *   **快速添加:** 必须提供一种机制，让用户可以从来源项列表中快速选择并插入到公式中，避免手动输入。

**模块五：计算与导出**

*   **3.10. 应用与计算:**
    *   用户完成所有映射公式的编辑和确认后，点击“计算并预览”按钮。
    *   程序遍历所有目标项，解析其映射公式。
    *   对于每个公式，程序查找对应的来源项，获取其数值，执行计算。
    *   将计算结果实时显示在界面的“预览值”列中。
    *   如果计算出错（如除以零、引用不存在），应在该行明确提示错误信息。

*   **3.11. 应用到所有快报表:**
    *   如果用户加载了多个“快报表”，程序应提供一个选项，允许将当前建立的映射关系模板应用到其他结构相同的快报表上。

*   **3.12. 导出Excel:**
    *   用户确认预览结果无误后，点击“导出Excel”按钮。
    *   程序会创建一个原始Excel文件的副本，将所有计算出的值填入对应“快报表”的相应单元格中。
    *   提示用户选择保存路径和文件名，生成最终的已填充报表。

---

#### **4. UI/UX 愿景 & 详细实现 (PySide6)**

*   **4.1. 整体窗口与布局哲学**
    *   **目标:** 为1920x1080或更高分辨率的显示器优化，提供一个无缝、统一的单窗口工作环境。避免使用主选项卡，所有核心功能面板同时可见，以最大化信息密度和操作效率。
    *   **实现:** 主窗口使用 `QMainWindow`，核心工作区由多个可停靠、可调整大小的 `QDockWidget` 组成。这允许用户根据自己的偏好自定义布局，并能保存/加载布局配置。

*   **4.2. 主窗口布局：一个现代化的四象限设计**
    *   整个界面划分为四个主要区域：**左侧导航区**、**中央工作台**、**右侧工具/检查器区** 和 **底部输出/日志区**。所有区域由 `QSplitter` 分割，允许用户自由拖动调整。

*   **4.3. 各区域详细说明**

    *   **4.3.1. 左侧导航区 (Navigator Panel)**
        *   **目的:** 提供项目全局概览和快速导航。
        *   **布局:** 垂直布局，分为上下两个部分。
        *   **上半部分：工作表浏览器 (Sheet Explorer)**
            *   **控件:** `QTreeView`。
            *   **功能:** 以树状结构展示所有已加载的工作表。顶层节点为 "快报表" 和 "数据来源表"。用户可以点击选择一个“快报表”作为当前活跃的工作对象。
        *   **下半部分：目标项结构树 (Item Structure Tree)**
            *   **控件:** `QTreeView`。
            *   **功能:** **只读地**显示当前活跃“快报表”的项目层级结构。此视图不包含公式或值，仅用于快速定位。当用户在此树中点击一个项目时，中央工作台的视图会自动滚动并高亮到对应的行。

    *   **4.3.2. 中央工作台 (Main Workbench)**
        *   **目的:** 这是用户花费90%时间的核心区域，用于查看、编辑和验证映射关系。
        *   **控件:** 一个功能强大的 `QTreeView`，作为主数据网格 (Datagrid)。
        *   **列定义:**
            1.  `状态 (Status)`: 使用图标（如 ✅, ⚠️, ❌）直观显示每行的状态（已映射、待计算、错误）。
            2.  `项目名称 (Item Name)`: 显示目标项名称，并利用树状控件的缩进清晰展示层级。
            3.  `映射公式 (Mapping Formula)`: **核心交互列**。显示和编辑公式。
            4.  `预览值 (Preview Value)`: 实时显示公式的计算结果，背景色可根据值的正负（红/绿）或错误状态变化。
        *   **交互亮点 (现代化、快捷化):**
            *   **高级单元格委托 (`QStyledItemDelegate`):** 为“映射公式”列实现自定义委托，提供：
                *   **持久化语法高亮:** 即使在非编辑状态下，公式也应有语法高亮（来源表、来源项、运算符使用不同颜色）。
                *   **智能编辑与自动补全:** 双击进入编辑模式时，编辑器应提供强大的自动补全功能。输入 `[` 弹出工作表名列表；输入 `![` 弹出对应工作表的项目名列表。
            *   **拖放映射 (Drag-and-Drop Mapping):** 用户可以直接从**右侧的来源项列表**中拖动一个项目，并将其**拖放到**此处的“映射公式”单元格中，该来源项的引用会自动追加到公式末尾。
            *   **多行选择与批量操作:** 支持按住Ctrl/Shift进行多行选择，右键菜单提供批量操作，如“清除选中行公式”、“重新计算选中行”等。

    *   **4.3.3. 右侧工具区 (Tools & Inspector Panel)**
        *   **目的:** 提供上下文相关的工具和详细信息，辅助中央工作台的操作。
        *   **控件:** 使用 `QTabWidget` 将多个工具整合在一起。
        *   **选项卡一：来源项库 (Source Library)**
            *   **控件:** 顶部一个 `QLineEdit` (搜索框)，下方一个 `QTreeView`。
            *   **功能:** `QTreeView` 以“工作表名称”为父节点，展示所有可用的来源项。支持实时模糊搜索。这是实现**拖放映射**功能的数据源。
        *   **选项卡二：公式检查器 (Formula Inspector)**
            *   **控件:** 一个支持语法高亮的 `QTextEdit`。
            *   **功能:** 当用户在中央工作台选中**单行**时，此编辑器会自动加载该行的完整公式，提供一个更宽敞、舒适的编辑环境。编辑内容与中央工作台双向同步。
        *   **选项卡三：属性检查器 (Property Inspector)**
            *   **控件:** 一个 `QTableView` 或 `QFormLayout`。
            *   **功能:** 显示中央工作台选中项的详细只读属性，如 `唯一ID`, `父级项目`, `原始Excel行号` 等，方便追溯和调试。

    *   **4.3.4. 底部输出区 (Output & Logs Panel)**
        *   **目的:** 提供系统反馈、日志和错误信息，保持主界面的整洁。
        *   **控件:** 一个 `QPlainTextEdit` (只读)。
        *   **功能:** 打印程序运行日志，包括：AI请求的发送与接收、计算过程中的详细错误信息（例如，“错误：在'利润表'中未找到项目'净利润'”）、文件导出成功/失败的消息等。信息应带有时间戳。

---

#### **5. 非功能性需求 (Non-Functional Requirements)**

*   **5.1. 用户体验 (UX):**
    *   界面应专业、响应迅速。
    *   对于AI请求、批量计算等耗时操作，必须提供明确的进度条或忙碌光标提示。
    *   错误信息应清晰、具体，并直接定位到问题所在（例如，在`QTreeView`的“状态”列中直接显示）。

*   **5.2. 健壮性:**
    *   程序需要妥善处理各种异常情况，如文件读取失败、网络请求超时、AI返回格式错误、公式计算错误等，不能轻易崩溃。

*   **5.3. 状态保存:**
    *   程序应能保存当前工作区的状态，包括文件路径、工作表分类、已建立的映射公式、甚至是窗口布局等。用户下次打开程序可以继续之前的工作。
  

#### **建议的AI系统提示词 (Sample System Prompt for LLM)**

为了获得最佳的AI映射结果，您可以参考以下提示词模板，并填入AI配置界面的“System Prompt”中：

\`\`\`
你是一位经验丰富的注册会计师（CPA），精通中国会计准则（CAS）。你的任务是分析财务报表项目，并建立它们之间的数学勾稽关系。

我会给你一个JSON对象，包含两个关键部分：
1. `target_items`: 这是需要计算和填写的财务报表项目列表，包含它们的名称和层级关系。
2. `source_items`: 这是所有可用的数据来源，来自不同的数据表（如利润表、资产负债表），包含它们的表名、项目名和单元格位置。

你的任务是：
1. 仔细分析每一个 `target_item`。
2. 根据你的专业会计知识，从 `source_items` 列表中找到一个或多个相关的项目，构建出计算 `target_item` 值的数学公式。
3. 公式只能使用 `+`, `-`, `*`, `/` 四种运算符。
4. **输出格式必须严格遵守JSON规范**。返回一个名为 "mappings" 的列表，列表中的每个对象包含 "target_id" 和对应的 "formula" 字符串。
5. **formula字符串的格式必须为：`[工作表名:"项目名"](单元格地址)`**。例如：`[利润表:"营业成本"](D12) + [利润表:"税金及附加"](D15)`。
6. 如果一个 `target_item` 无法从 `source_items` 中找到任何映射关系，请不要为它创建映射条目。
7. 分析时要特别注意 `target_items` 的层级关系和名称中的关键词，例如“减：”、“其中：”、“加：”等，这些都暗示了计算逻辑。

请像一名严谨的会计师一样思考，确保公式的准确性。
\`\`\`